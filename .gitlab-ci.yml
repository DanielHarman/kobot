stages:
  - build
  - test
  - dockerbuild
  - deploy
  
build:
  stage: build
  image: gradle:jdk14
  tags:
    - docker
  script:
    - ./gradlew --build-cache assemble
  artifacts:
    paths:
      - build/libs

test:
  stage: test
  image: gradle:jdk14
  tags:
    - docker
  script: ./gradlew check --info

dockerbuild:
  stage: dockerbuild
  tags:
    - shell 
  rules:
    - if: '$CI_COMMIT_REF_NAME == "master"'
      when: always
  before_script:
    - "docker --version"
    - "docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY"
  script:
    - "docker build -t ${CI_REGISTRY}/${CI_PROJECT_PATH}:latest -t ${CI_REGISTRY}/${CI_PROJECT_PATH}:${CI_COMMIT_SHA} --pull ."
    - "docker push ${CI_REGISTRY}/${CI_PROJECT_PATH}:${CI_COMMIT_SHA}"
    - "docker push ${CI_REGISTRY}/${CI_PROJECT_PATH}:latest"
  after_script:
    - "docker logout ${CI_REGISTRY}"
    
deploy:
  stage: deploy
  tags:
    - shell
  rules:
    - if: '$CI_COMMIT_REF_NAME == "master"'
      when: always
  variables:
    GIT_STRATEGY: none
  before_script:
    - "docker --version"
    - "docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY"
    - "docker stack services kotlinBot"
  script:
    - "docker pull  ${CI_REGISTRY}/${CI_PROJECT_PATH}:latest"
    - "docker pull  ${CI_REGISTRY}/${CI_PROJECT_PATH}:${CI_COMMIT_SHA}"
    - "docker service update --with-registry-auth --image ${CI_REGISTRY}/${CI_PROJECT_PATH}:${CI_COMMIT_SHA} kotlinBot_bot"
  after_script:
    - "docker logout ${CI_REGISTRY}"
